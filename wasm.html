<html>
    <head>
        <title>WebAssembly test page</title>
        <meta name="description" content="Test how your browser handles WebAssembly." />
        <link rel="stylesheet" type="text/css" href="css/common.css">
        <link rel="import" href="imports/listing.html">
        <script type="application/javascript" src="js/webcomponents.js"></script>
    </head>
    <body>
        <p><a href="." title="Test pages">&lt;&lt; Test pages</a></p>
        <h1>WebAssembly test page</h1>
        <p>
            This page tests how your browser handles
            <a href="https://developer.mozilla.org/en-US/docs/WebAssembly" title="WebAssembly">WebAssembly</a>.
            WebAssembly is a type of low-level byte code that can be run within
            a browsers virtual machine with interop to JavaScript code.
            Rather than being written, WASM is intended to be generated by a compiler.
            Source languages include C++, Rust and Go.
        </p>
        <p>
            WASM is packaged into modules.
            These modules can import functions from JavaScript and export functions to JavaScript.
            Currently browsers only support loading WASM code programmatically.
            First the WASM byte code must be fetched either as a
            <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response" title="Response">Response</a> or
            <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" title="ArrayBuffer">ArrayBuffer</a>.
            It can then be instantiated, passing in the functions to be imported by the module.
            Instantiation resolves to an object with the compiled
            <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Module" title="WebAssembly.Module">WebAssembly.Module</a>
            and a usable
            <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Instance" title="WebAssembly.Instance">WebAssembly.Instance</a>.
            The functions exported by the WASM module can be obtained from the instance.
        </p>
        <h2>Example</h2>
        <x-listing data-caption="Calling WASM">WebAssembly
    .instantiateStreaming(fetch('wasm/wasm.wasm'))
    .then(result => result.instance.exports.increment)
    .then(increment => increment(5));</x-listing>
        <h2>Results</h2>
        <noscript>
            <p>
                JavaScript is not supported or disabled in your browser.
                There is no chance of this working.
            </p>
        </noscript>
        <p id="supported"></p>

        <script>
            var supported = document.getElementById('supported');

            function handle_module(result) {
                supported.innerText += ' WASM code has been fetched.';

                var increment = result.instance.exports.increment;
                if (increment) {
                    supported.innerText += ' Functions exported by WASM code can be imported.';
                    if (increment(2) === 3) {
                        supported.innerText += ' WASM code is callable.';
                    }
                    else {
                        supported.innerText += ' Problem with WASM code.';
                    }
                }
                else {
                    supported.innerText += ' Failed to import function from WASM code.';
                }
            }

            function handle_module_error(err) {
                supported.innerText += ' WASM code could not be fetched.';
            }

            if (window.WebAssembly) {
                supported.innerText = 'WebAssembly object found.';

                if (!window.fetch) {
                    supported.innerText += ' Fetch not available to load WASM code.';
                }
                else {
                    WebAssembly
                        .instantiateStreaming(fetch('wasm/wasm.wasm'))
                        .then(handle_module, handle_module_error);
                }
            }
            else {
                supported.innerText = 'No WebAssembly object found.';
            }
        </script>
    </body>
</html>
